import type { Root as HastRoot } from 'hast';
import { EXIT, visit } from 'unist-util-visit';

import { downloadImage } from '../utils/images.js';

export async function downloadFavicon(hast: HastRoot): Promise<string | undefined> {
  let src: string = '';
  visit(hast, 'element', function (node) {
    if (
      node.tagName === 'link' &&
      typeof node.properties.rel === 'string' &&
      (node.properties.rel === 'icon' || node.properties.rel === 'shortcut icon')
    ) {
      src = node.properties.href as string;
      return EXIT;
    }
  });

  if (!src) return undefined;

  const res = await downloadImage(src, process.cwd());
  if (!res.success) return undefined;
  if (!res.data) return undefined;

  return res.data[1];
}
